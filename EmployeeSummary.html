<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICM - Employee Summary</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/toast.css">
    <link rel="shortcut icon" href="https://backend.quadient.com/files/default/favicon-quadient.png">
    <style>
        .search-section { max-width: 700px; width: 100%; margin: 0 auto; }
        .search-card {
            background: white; border-radius: var(--border-radius);
            box-shadow: var(--shadow-md); padding: 40px;
        }
        .search-card h3 { font-weight: 600; color: var(--blue2); font-size: 1.3em; margin: 0 0 8px 0; }
        .search-card > p { color: var(--black2); font-size: 0.95em; margin: 0 0 25px 0; }

        .search-row { display: flex; gap: 12px; flex-wrap: wrap; }
        .search-input {
            flex: 1; min-width: 150px; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 1em; transition: border-color 0.2s; background: #fafbfc;
        }
        .search-input:focus { border-color: var(--blue2); background: white; outline: none; }
        .search-select {
            padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 1em; background: #fafbfc; min-width: 100px; cursor: pointer;
        }
        .search-select:focus { border-color: var(--blue2); background: white; outline: none; }
        .btn-search {
            padding: 12px 28px; background: var(--gradient-navy); color: white; border: none;
            border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-search:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn-search:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .autocomplete-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 100;
            background: white; border: 2px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;
            max-height: 280px; overflow-y: auto; display: none; box-shadow: var(--shadow-md);
        }
        .autocomplete-dropdown.visible { display: block; }
        .autocomplete-item {
            padding: 10px 16px; cursor: pointer; font-size: 0.95em;
            border-bottom: 1px solid #f0f0f0; transition: background 0.15s;
        }
        .autocomplete-item:hover, .autocomplete-item.active { background: #eef3fb; }
        .autocomplete-item .emp-name { font-weight: 600; color: var(--blue2); }
        .autocomplete-item .emp-login { color: #999; font-size: 0.85em; margin-left: 8px; }
        .autocomplete-item:last-child { border-bottom: none; }

        .search-error { color: #e53935; font-size: 0.9em; margin-top: 8px; display: none; }
        .search-error.visible { display: block; }

        .results-section { max-width: 1400px; width: 100%; margin: 30px auto 0; display: none; }
        .results-section.visible { display: block; }

        .summary-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px; margin-bottom: 30px;
        }
        .summary-stat {
            background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow-sm);
            text-align: center; border-top: 3px solid var(--blue2);
        }
        .summary-stat.green { border-top-color: #00c4b3; }
        .summary-stat.orange { border-top-color: #e67e22; }
        .summary-stat .stat-label { font-size: 0.8em; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-stat .stat-value { font-size: 1.4em; font-weight: 700; color: var(--blue2); margin-top: 4px; }
        .summary-stat.green .stat-value { color: #00a89d; }
        .summary-stat.orange .stat-value { color: #d35400; }

        .data-section {
            background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-md);
            margin-bottom: 20px; overflow: hidden;
        }
        .section-header {
            padding: 18px 24px; cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; background: #f8f9fa; border-bottom: 1px solid #eee;
            transition: background 0.2s; user-select: none;
        }
        .section-header:hover { background: #eef1f5; }
        .section-header h4 {
            margin: 0; font-size: 1.05em; font-weight: 600; color: var(--blue2);
            display: flex; align-items: center; gap: 10px;
        }
        .section-header .badge {
            background: var(--blue2); color: white; padding: 2px 10px; border-radius: 12px;
            font-size: 0.8em; font-weight: 600;
        }
        .section-header .chevron { transition: transform 0.3s; font-size: 1.2em; color: #999; }
        .section-header.collapsed .chevron { transform: rotate(-90deg); }
        .section-body { padding: 0; }
        .section-body.collapsed { display: none; }

        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .data-table thead th {
            background: #f0f3f7; padding: 12px 16px; text-align: left; font-weight: 600;
            color: var(--blue2); border-bottom: 2px solid #dde3eb; white-space: nowrap;
            position: sticky; top: 0;
        }
        .data-table tbody td { padding: 10px 16px; border-bottom: 1px solid #f0f0f0; color: #333; }
        .data-table tbody tr:hover { background: #f8fafe; }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-mono { font-family: 'Courier New', monospace; }
        .text-truncate { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .empty-state { padding: 30px; text-align: center; color: #999; font-style: italic; }

        .pill { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 500; }
        .pill-yes { background: #e8f5e9; color: #2e7d32; }
        .pill-no { background: #fce4ec; color: #c62828; }

        .header-info {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px; padding: 24px;
        }
        .info-item { display: flex; flex-direction: column; gap: 4px; }
        .info-label { font-size: 0.8em; color: #999; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .info-value { font-size: 1em; color: #333; font-weight: 500; }

        .table-scroll { overflow-x: auto; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .loading-box { background: white; padding: 40px; border-radius: 12px; text-align: center; }
        .spinner {
            width: 48px; height: 48px; border: 4px solid #e0e0e0;
            border-top-color: var(--blue2); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .btn-back {
            display: inline-flex; align-items: center; gap: 6px; padding: 8px 20px;
            background: transparent; color: var(--blue2); border: 2px solid var(--blue2);
            border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer;
            transition: all 0.2s; margin-bottom: 20px;
        }
        .btn-back:hover { background: var(--blue2); color: white; }

        .payment-total-row {
            background: #e8f5e9; font-weight: 700; font-size: 1.05em;
        }

        /* Nested order lines */
        .order-group { margin-bottom: 2px; }
        .order-group-header {
            padding: 12px 16px; background: #f0f3f7; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center; border-bottom: 1px solid #dde3eb;
            user-select: none;
        }
        .order-group-header:hover { background: #e8ecf2; }
        .order-group-header .chevron { transition: transform 0.3s; font-size: 1em; color: #999; }
        .order-group-header.collapsed .chevron { transform: rotate(-90deg); }
        .order-group-body { display: block; }
        .order-group-body.collapsed { display: none; }
    </style>
</head>
<body>
    <header class="icm-header">
        <div class="header-container">
            <a href="index.html" class="header-brand">
                <div class="header-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                </div>
                <div class="header-titles">
                    <span class="header-app-name">ICM</span>
                    <span class="header-app-desc">Incentive & Compensation Management</span>
                </div>
            </a>
            <nav class="header-nav">
                <a href="index.html" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    Home
                </a>
                <a href="GenerateDealsReports.html" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    Reports
                </a>
                <a href="ICMProcessRunner.html" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    Run Process
                </a>
            </nav>
            <div class="server-info">
                <div class="server-info-item"><span class="server-info-label">Server</span><span class="server-info-value loading" id="serverInfoServer">Loading...</span></div>
                <div class="server-info-item"><span class="server-info-label">Sales Period</span><span class="server-info-value loading" id="serverInfoSP">Loading...</span></div>
                <div class="server-info-item"><span class="server-info-label">Status</span><span class="server-info-value loading" id="serverInfoStatus">Loading...</span></div>
                <div class="server-info-item"><span class="server-info-label">Last Run</span><span class="server-info-value loading" id="serverInfoLastRun">Loading...</span></div>
            </div>
            <div class="header-right">
                <svg xmlns="http://www.w3.org/2000/svg" width="200" height="50" viewBox="0 0 200 50" class="quadient-logo">
                    <g transform="translate(0.007 0)">
                        <path d="M23.781,64.111a1.528,1.528,0,0,1,.432,1.1V99.323a1.443,1.443,0,0,1-.432,1.074,1.6,1.6,0,0,1-2.172,0,1.44,1.44,0,0,1-.428-1.074v-15a10.835,10.835,0,0,1-3.769,3.9,10.046,10.046,0,0,1-5.534,1.6A11,11,0,0,1,5.832,88.1,12.084,12.084,0,0,1,1.562,83.32a15.655,15.655,0,0,1,0-13.656,12.069,12.069,0,0,1,4.271-4.777,10.9,10.9,0,0,1,5.991-1.726,10.752,10.752,0,0,1,5.514,1.476,10.156,10.156,0,0,1,3.843,3.827V65.21a1.515,1.515,0,0,1,2.6-1.1Z" transform="translate(0 -50.824)" fill="white"></path>
                    </g>
                </svg>
            </div>
        </div>
    </header>

    <div class="content">
        <div class="title"><h2>Employee Summary</h2></div>

        <!-- Loading -->
        <div id="loadingOverlay" class="loading-overlay" style="display:none;">
            <div class="loading-box">
                <div class="spinner"></div>
                <h3>Loading Employee...</h3>
                <p>Fetching employee details from the server.</p>
            </div>
        </div>

        <!-- Search -->
        <div class="search-section" id="searchSection">
            <div class="search-card">
                <h3>Search Employee</h3>
                <p>Start typing an employee name to search.</p>
                <div class="search-row" style="position: relative;">
                    <input type="text" class="search-input" id="loginInput" placeholder="Type employee name..." autocomplete="off">
                    <button class="btn-search" id="btnSearch" onclick="searchEmployee()" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        Search
                    </button>
                    <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div class="search-error" id="searchError"></div>
            </div>
        </div>

        <!-- Results -->
        <div class="results-section" id="resultsSection">
            <button class="btn-back" onclick="resetSearch()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                New Search
            </button>

            <!-- Quick Stats -->
            <div class="summary-grid" id="summaryGrid"></div>

            <!-- Employee Details -->
            <div class="data-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        Employee Details
                    </h4>
                    <span class="chevron">▼</span>
                </div>
                <div class="section-body">
                    <div class="header-info" id="employeeInfo"></div>
                </div>
            </div>

            <!-- Allocated Orders -->
            <div class="data-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                        Allocated Orders
                        <span class="badge" id="allocOrdersCount">0</span>
                    </h4>
                    <span class="chevron">▼</span>
                </div>
                <div class="section-body">
                    <div class="table-scroll" id="allocOrdersTable"></div>
                </div>
            </div>

            <!-- Unit Summary -->
            <div class="data-section">
                <div class="section-header collapsed" onclick="toggleSection(this)">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                        Unit Summary
                        <span class="badge" id="unitCount">0</span>
                    </h4>
                    <span class="chevron">▼</span>
                </div>
                <div class="section-body collapsed">
                    <div class="table-scroll" id="unitTable"></div>
                </div>
            </div>

            <!-- Order Allocation Totals -->
            <div class="data-section">
                <div class="section-header collapsed" onclick="toggleSection(this)">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a10 10 0 0 1 0 20"></path></svg>
                        Order Allocation Totals
                        <span class="badge" id="orderAllocCount">0</span>
                    </h4>
                    <span class="chevron">▼</span>
                </div>
                <div class="section-body collapsed">
                    <div class="table-scroll" id="orderAllocTable"></div>
                </div>
            </div>

            <!-- Allocation Totals -->
            <div class="data-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                        Allocation Totals
                        <span class="badge" id="allocTotalCount">0</span>
                    </h4>
                    <span class="chevron">▼</span>
                </div>
                <div class="section-body">
                    <div class="table-scroll" id="allocTotalTable"></div>
                </div>
            </div>

            <!-- Payment Details -->
            <div class="data-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                        Payment Details
                        <span class="badge" id="payCount">0</span>
                    </h4>
                    <span class="chevron">▼</span>
                </div>
                <div class="section-body">
                    <div class="table-scroll" id="payTable"></div>
                </div>
            </div>

            <!-- Adjustments -->
            <div class="data-section">
                <div class="section-header collapsed" onclick="toggleSection(this)">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                        Adjustments
                        <span class="badge" id="adjCount">0</span>
                    </h4>
                    <span class="chevron">▼</span>
                </div>
                <div class="section-body collapsed">
                    <div class="table-scroll" id="adjTable"></div>
                </div>
            </div>

            <!-- Order Lines (nested) -->
            <div class="data-section">
                <div class="section-header collapsed" onclick="toggleSection(this)">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                        Order Lines
                        <span class="badge" id="orderLinesCount">0</span>
                    </h4>
                    <span class="chevron">▼</span>
                </div>
                <div class="section-body collapsed">
                    <div id="orderLinesContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/common.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/employee-summary.js"></script>
</body>
</html>
